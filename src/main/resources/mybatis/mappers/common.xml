<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="common">

	<select id="findAllAttendanceSchedule" resultType="attendanceScheduleVo">
		<![CDATA[
			select * from attendance_schedule;
		]]>
	</select>
	<select id="findAllAttendanceScheduleByNo" resultType="attendanceScheduleVo">
		<![CDATA[
			select * from attendance_schedule where no = #{no};
		]]>
	</select>
	<insert id="insertAttendanceSchedule" parameterType="attendanceScheduleVo">
		<![CDATA[
			insert into attendance_schedule(no, start_date, end_date, status, remark, is_confirmed, hospital_no, employee_no, employee_no1, hospital_no1) 
			values (#{no},#{startDate}, #{endDate}, #{status}, #{remark}, #{is_confirmed}, #{hospital_no}, #{employee_no}, #{employee_no1}, #{hospital_no1});
		]]>
		<selectKey keyProperty="no" resultType="long" order="AFTER">
			<![CDATA[
				select last_insert_id();
			]]>
		</selectKey>
	</insert>
	
	<update id="updateAttendanceSchedule" parameterType="long">
		<![CDATA[
			update attendance_schedule 
			set start_date = #{startDate}, end_date = #{endDate}, status = #{status}, remark = #{remark},
			is_confirmed = #{isConfirmed}, hospital_no = #{hospitalNo}, employee_no = #{employeeNo},
			employeeNo1 = #{employeeNo1}, hopistal_no1 = #{hospitalNo1} 
			where no = #{no}
		]]>
	</update>	
	<delete id="deleteHospitalAdmin" parameterType="long">
		<![CDATA[
			delete from attendance_schedule where no = #{no};
		]]>
	</delete>
	
	<!-- 진료 내역 start -->
	<select id="findPatientByDoctor" parameterType="map" resultType="doctorvo">
		<![CDATA[
			select 
				a.no as appointmentNo,
				date_format(a.date, '%h:%m:%s') as appointmentDate, 
				a.remarks as appointmentRemark,
				a.status,
				b.no as patientNo, 
				b.name as patientName, 
				a.employee_no as employeeNo,
				c.name as employeeName
			from appointment a 
				left join patient b on a.patient_no = b.no
				left join employee c on a.employee_no = c.no
			where a.hospital_no = #{hospital} 
				and a.status between 2 and 3
				and c.email = #{email}
				and date_format(a.date, '%Y-%m-%d' ) = date_format(now(), '%Y-%m-%d')
			order by a.status, a.date desc
			limit #{page}, 10
		]]>
	</select>
	
	<select id="findPatient" parameterType="map" resultType="doctorvo">
		<![CDATA[
		select 
			a.no as appointmentNo,	
			date_format(a.date, '%h:%m:%s') as appointmentDate, 
			a.remarks as appointmentRemark,
			a.status, 
			b.no as patientNo, 
			b.name as patientName, 
			a.employee_no as employeeNo,
			c.name as employeeName
		from appointment a 
			left join patient b on a.patient_no = b.no
			left join employee c on a.employee_no = c.no
		where a.hospital_no = #{hospital} 
			and a.status between 2 and 3 
			and date_format(a.date, '%Y-%m-%d' ) = date_format(now(), '%Y-%m-%d')
		order by a.status, a.date desc	
		limit #{page}, 10
		]]>
	</select>
	
	<select id="findRecordCount" parameterType="map" resultType="int">
		<choose>
			<when test='role == "의사"'>
				<![CDATA[
					select count(*)
					from appointment a 
						left join employee c on a.employee_no = c.no
					where a.hospital_no = #{hospital} 
						and a.status between 2 and 3
						and c.email = #{email}
						and date_format(a.date, '%Y-%m-%d' ) = date_format(now(), '%Y-%m-%d')
				]]>
			</when>	
			<otherwise>
				<![CDATA[
					select count(*)
					from appointment a 
						left join employee c on a.employee_no = c.no
					where a.hospital_no = #{hospital} 
						and a.status between 2 and 3
						and date_format(a.date, '%Y-%m-%d' ) = date_format(now(), '%Y-%m-%d')
				]]>
			</otherwise>	
		</choose>
	</select>
	
	<!-- 진료 내역 end -->
</mapper>